import { Campaign, CampaignType, UserSegment, EventType, CampaignStats, TimePeriod } from '../types';
import { SeaBattleSessionManager } from './seaBattleEngine';
import { registerEvent } from './ltvEngine';
import { recordCampaignSend } from './campaignTrackingService';
import { isDateInPeriod } from '../utils/dateHelpers';

const CAMPAIGNS_STORAGE_KEY = 'campaigns_local_cache';

const hydrateFromStorage = (): Campaign[] => {
  if (typeof localStorage === 'undefined') return [];
  try {
    const stored = localStorage.getItem(CAMPAIGNS_STORAGE_KEY);
    if (!stored) return [];
    const parsed = JSON.parse(stored);
    return Array.isArray(parsed) ? parsed : [];
  } catch (err) {
    console.warn('Failed to load campaigns from storage', err);
    return [];
  }
};

export const persistCampaigns = (campaigns: Campaign[]) => {
  if (typeof localStorage === 'undefined') return;
  try {
    localStorage.setItem(CAMPAIGNS_STORAGE_KEY, JSON.stringify(campaigns));
  } catch (err) {
    console.warn('Failed to persist campaigns', err);
  }
};

type CampaignFilter = {
  segment_target?: UserSegment | 'ALL';
  min_games?: number;
  is_member?: boolean;
};

const apiFetch = async <T>(url: string, init?: RequestInit): Promise<T | null> => {
  try {
    const response = await fetch(url, init);
    if (!response.ok) {
      console.warn(`Request to ${url} failed with status ${response.status}`);
      return null;
    }
    return (await response.json()) as T;
  } catch (err) {
    console.error(`Failed to call ${url}`, err);
    return null;
  }
};

export const hydrateCampaigns = async (): Promise<Campaign[]> => {
  const campaigns = await apiFetch<Campaign[]>('/api/campaigns');
  const fromApi = Array.isArray(campaigns) ? campaigns : [];

  if (fromApi.length > 0) {
    persistCampaigns(fromApi);
    return fromApi;
  }

  const fallback = hydrateFromStorage();
  return fallback;
};

export const launchCampaign = async (
  campaign: Campaign,
  filters: CampaignFilter = {}
): Promise<Campaign | null> => {
  if (!campaign) return null;

  const imageBase64 = (campaign as any).image_base64 || (campaign as any).imageBase64 || (campaign as any).imageData;
  const imageUrl = !imageBase64 ? (((campaign as any).imageUrl || campaign.image_url || '').trim()) : '';
  const voiceBase64 = (campaign as any).voice_base64;
  const voiceUrl = !voiceBase64 ? (((campaign as any).voice_url || (campaign as any).voiceUrl || '').trim()) : '';
  const messageType = (campaign as any).message_type || (campaign as any).messageType || 'DEFAULT';
  const carouselCards = (campaign as any).carouselCards || [];
  const hydratedCampaign: Campaign = {
    ...campaign,
    image_url: imageBase64 ? undefined : (imageUrl || undefined),
    image_base64: imageBase64 || (typeof imageUrl === 'string' && imageUrl.startsWith('data:') ? imageUrl : undefined),
    image_name: (campaign as any).image_name,
    ...(imageUrl ? { imageUrl } : { imageUrl: undefined } as any),
    voice_url: voiceUrl || voiceBase64 || undefined,
    ...(voiceUrl ? { voiceUrl } : voiceBase64 ? { voiceUrl: undefined } : {} as any),
    voice_base64: voiceBase64 || undefined,
  };

  let sentCount = 0;
  let recipientsFromApi: { userId?: number; vkId?: number; segment?: UserSegment | 'ALL' }[] = [];

  const apiPayload = {
    campaignId: campaign.id,
    message: campaign.message,
    type: messageType === 'CAROUSEL' ? 'CAROUSEL' : campaign.type,
    messageType,
    campaignType: campaign.type,
    segment: campaign.segment_target,
    imageUrl,
    image_url: imageUrl,
    image_base64: imageBase64,
    imageBase64: imageBase64 || '',
    imageName: (campaign as any).image_name,
    voiceUrl,
    voice_url: voiceUrl,
    voiceBase64: voiceBase64,
    voiceName: (campaign as any).voice_name,
    filters,
    carousel,
  };

  const apiResult = await apiFetch<{ sent?: number; recipients?: any[] }>('/api/campaigns/send', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(apiPayload),
  });

  if (apiResult) {
    sentCount = apiResult.sent ?? 0;
    recipientsFromApi = (apiResult.recipients || []).map((r: any) => ({
      userId: r.id ?? r.user_id,
      vkId: r.vkId ?? r.vk_id ?? r.user_vk_id,
      segment: r.segment ?? (campaign.segment_target ?? 'ALL'),
    }));
  }

  const recipients = recipientsFromApi.length ? recipientsFromApi : [];

  recipients.forEach((recipient) => {
    recordCampaignSend(campaign.id, {
      userId: recipient.userId,
      vkId: recipient.vkId,
      segment: recipient.segment,
    });

    if (recipient.userId && Math.random() > 0.7) {
      registerEvent({ id: recipient.userId } as any, EventType.PUSH_OPEN, { campaign_id: campaign.id });
    }

    if (campaign.type === CampaignType.GAME_BATTLESHIP && recipient.userId) {
      SeaBattleSessionManager.startSession(recipient.userId, campaign.id);
    }
  });

  if (sentCount === 0) {
    sentCount = recipients.length;
  }

  const baseStats: CampaignStats = {
    ...campaign.stats,
    sent: sentCount,
    delivered: sentCount ? Math.floor(sentCount * 0.98) : campaign.stats.delivered,
    clicked: campaign.stats.clicked || 0,
  };

  const updatedStats = campaign.type === CampaignType.GAME_BATTLESHIP
    ? {
        ...baseStats,
        games_started: sentCount,
        players_active: 0,
        games_finished: campaign.stats.games_finished ?? 0,
        avg_moves: 0,
      }
    : baseStats;

  return {
    ...hydratedCampaign,
    status: 'SENT',
    stats: updatedStats,
  };
};

export const recalculateGameStats = (campaign: Campaign, period: TimePeriod = 'ALL'): CampaignStats => {
    if (campaign.type !== CampaignType.GAME_BATTLESHIP) return campaign.stats;

    const started = campaign.stats.games_started ?? 0;
    const finished = campaign.stats.games_finished ?? 0;
    const active = campaign.stats.players_active ?? 0;

    const totalMoves = campaign.stats.avg_moves && started ? campaign.stats.avg_moves * started : 0;
    const avgMoves = started > 0 ? Math.round(totalMoves / started) : 0;

    return {
        ...campaign.stats,
        games_started: period === 'ALL' ? started : started,
        games_finished: period === 'ALL' ? finished : finished,
        players_active: period === 'ALL' ? active : active,
        avg_moves: period === 'ALL' ? avgMoves : avgMoves,
    };
};
